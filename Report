/**
 * Call History - Visual Flair + Dashboard
 * - No formulas
 * - No explicit any
 * - Hardened column lookup
 * - GUARANTEES visible charts by writing chart data into a fixed block and positioning charts near it
 */
function main(workbook: ExcelScript.Workbook) {
  const srcSheet = workbook.getActiveWorksheet();
  const used = srcSheet.getUsedRange();

  if (!used) throw new Error("No used range found on the active sheet.");
  if (used.getRowCount() < 2) throw new Error("Not enough rows (need header + at least 1 data row).");

  // ---------- Create / refresh table ----------
  const tableName = "CallHistory";

  for (const t of workbook.getTables()) {
    if (t.getName() === tableName) {
      t.delete();
      break;
    }
  }

  const table = workbook.addTable(used, true);
  table.setName(tableName);
  table.setPredefinedTableStyle("TableStyleMedium9");

  // Freeze header row (defensive)
  try {
    const fp = srcSheet.getFreezePanes();
    try { fp.unfreeze(); } catch { /* ignore */ }
    fp.freezeRows(1);
  } catch { /* ignore */ }

  // Autofit
  used.getFormat().autofitColumns();
  used.getFormat().autofitRows();

  // Header polish
  const headerRange = table.getHeaderRowRange();
  headerRange.getFormat().getFont().setBold(true);
  headerRange.getFormat().setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
  headerRange.getFormat().setWrapText(true);

  // ---------- Helpers ----------
  function getColumnSafe(colName: string): ExcelScript.TableColumn | null {
    try {
      const col = table.getColumnByName(colName);
      return col ? col : null;
    } catch {
      return null;
    }
  }

  function getColValues(colName: string): (string | number | boolean)[][] | null {
    const col = getColumnSafe(colName);
    if (!col) return null;
    try {
      return col.getRangeBetweenHeaderAndTotal().getValues();
    } catch {
      return null;
    }
  }

  function setNumberFormatIfExists(colName: string, format: string): void {
    const col = getColumnSafe(colName);
    if (!col) return;
    col.getRangeBetweenHeaderAndTotal().setNumberFormatLocal(format);
  }

  function toNum(x: unknown): number {
    if (x === null || x === undefined) return 0;
    if (typeof x === "number") return x;
    if (typeof x === "boolean") return x ? 1 : 0;
    if (typeof x === "string") {
      const t = x.trim();
      if (t === "") return 0;
      const n = Number(t);
      return Number.isFinite(n) ? n : 0;
    }
    return 0;
  }

  function toStr(x: unknown): string {
    if (x === null || x === undefined) return "";
    if (typeof x === "string") return x;
    if (typeof x === "number") return String(x);
    if (typeof x === "boolean") return x ? "TRUE" : "FALSE";
    return "";
  }

  function findRowIndexByExactText(
    colValues: (string | number | boolean)[][] | null,
    needle: string
  ): number {
    if (!colValues) return -1;
    const target = needle.trim().toLowerCase();
    for (let i = 0; i < colValues.length; i++) {
      const v = toStr(colValues[i][0]).trim().toLowerCase();
      if (v === target) return i;
    }
    return -1;
  }

  function applyGreaterThanZeroHighlight(colName: string): void {
    const col = getColumnSafe(colName);
    if (!col) return;

    const r = col.getRangeBetweenHeaderAndTotal();
    const cf = r.addConditionalFormat(ExcelScript.ConditionalFormatType.cellValue);
    cf.getCellValue().setRule({
      formula1: "0",
      operator: ExcelScript.ConditionalCellValueOperator.greaterThan
    });
    const fmt = cf.getCellValue().getFormat();
    fmt.getFill().setColor("#FDE2E2");
    fmt.getFont().setColor("#9B1C1C");
    fmt.getFont().setBold(true);
  }

  // ---------- Formats ----------
  const timeCols = [
    "Avg Handle Time",
    "Avg InQueue Time",
    "Avg Abandon Time",
    "Avg Speed Of Answer",
    "Avg Inbound Time",
    "Avg Active Talk Time",
    "Avg Outbound Time",
    "Outbound Active Talk Time",
    "Active Talk Time",
    "Abandon Time",
    "Long Abandon Time",
    "Avg Short Abandon Time",
    "Held Party Abandon Time"
  ];
  for (const c of timeCols) setNumberFormatIfExists(c, "[h]:mm:ss");

  const pctCols = ["% PreQueue Time", "% Short Abandons", "% PostQueue Time"];
  for (const c of pctCols) setNumberFormatIfExists(c, "0.00%");

  const intCols = [
    "Inbound",
    "Inbound Handled",
    "Outbound Handled",
    "Abandons",
    "Callback Requests",
    "Entered Prequeue",
    "Held",
    "Long Abandons",
    "Incoming",
    "Outbound",
    "Prequeue Abandons",
    "Short Abandons",
    "Agent Contacts"
  ];
  for (const c of intCols) setNumberFormatIfExists(c, "0");

  applyGreaterThanZeroHighlight("Abandons");
  applyGreaterThanZeroHighlight("Prequeue Abandons");

  for (const c of pctCols) {
    const col = getColumnSafe(c);
    if (!col) continue;
    const r = col.getRangeBetweenHeaderAndTotal();
    const cf = r.addConditionalFormat(ExcelScript.ConditionalFormatType.dataBar);
    const db = cf.getDataBar();
    db.setShowDataBarOnly(false);
    try {
      const pf = db.getPositiveFormat();
      try { pf.setGradientFill(true); } catch { /* ignore */ }
    } catch { /* ignore */ }
  }

  // ---------- Dashboard ----------
  const dashName = "Dashboard";
  let dash = workbook.getWorksheet(dashName);
  if (dash) dash.delete();
  dash = workbook.addWorksheet(dashName);

  // Make sure columns are wide enough so charts aren't "off canvas"
  dash.getRange("A:A").getFormat().setColumnWidth(180);
  dash.getRange("B:B").getFormat().setColumnWidth(140);
  dash.getRange("C:C").getFormat().setColumnWidth(160);
  dash.getRange("D:D").getFormat().setColumnWidth(170);
  dash.getRange("E:E").getFormat().setColumnWidth(170);
  dash.getRange("F:F").getFormat().setColumnWidth(24);
  dash.getRange("G:G").getFormat().setColumnWidth(140);
  dash.getRange("H:H").getFormat().setColumnWidth(140);
  dash.getRange("I:I").getFormat().setColumnWidth(140);
  dash.getRange("J:J").getFormat().setColumnWidth(140);
  dash.getRange("K:K").getFormat().setColumnWidth(140);
  dash.getRange("L:L").getFormat().setColumnWidth(140);
  dash.getRange("M:M").getFormat().setColumnWidth(140);

  // Header band
  const headerBand = dash.getRange("A1:M2");
  headerBand.merge(true);
  headerBand.setValue("LBO Call History Dashboard");
  headerBand.getFormat().getFont().setBold(true);
  headerBand.getFormat().getFont().setSize(18);
  headerBand.getFormat().getFill().setColor("#111827");
  headerBand.getFormat().getFont().setColor("#FFFFFF");
  headerBand.getFormat().setHorizontalAlignment(ExcelScript.HorizontalAlignment.left);
  headerBand.getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.center);

  // KPI labels + values
  dash.getRange("A4:E4").setValues([[
    "Inbound (Total)",
    "Handled (Inbound)",
    "Abandons",
    "Callback Requests",
    "Avg Handle Time"
  ]]);
  dash.getRange("A4:E4").getFormat().getFont().setBold(true);

  const dayCol = getColValues("Day of Week");
  const inboundVals = getColValues("Inbound");
  const inboundHandledVals = getColValues("Inbound Handled");
  const abandonsVals = getColValues("Abandons");
  const cbReqVals = getColValues("Callback Requests");
  const ahtVals = getColValues("Avg Handle Time");
  const mediaVals = getColValues("Media Type Name");

  const gtIdx = findRowIndexByExactText(dayCol, "Grand Total");

  function sumColumn(vals: (string | number | boolean)[][] | null, excludeIdx: number): number {
    if (!vals) return 0;
    let s = 0;
    for (let i = 0; i < vals.length; i++) {
      if (i === excludeIdx) continue;
      s += toNum(vals[i][0]);
    }
    return s;
  }

  function valueOrSum(vals: (string | number | boolean)[][] | null, preferredIndex: number): number {
    if (!vals) return 0;
    if (preferredIndex >= 0 && preferredIndex < vals.length) return toNum(vals[preferredIndex][0]);
    return sumColumn(vals, -1);
  }

  const inboundTotal = valueOrSum(inboundVals, gtIdx);
  const inboundHandledTotal = valueOrSum(inboundHandledVals, gtIdx);
  const abandonsTotal = valueOrSum(abandonsVals, gtIdx);
  const cbReqTotal = valueOrSum(cbReqVals, gtIdx);

  let avgHandleTime = 0;
  if (ahtVals && inboundHandledVals) {
    let numerator = 0;
    let denom = 0;
    for (let i = 0; i < ahtVals.length; i++) {
      if (i === gtIdx) continue;
      const ht = toNum(ahtVals[i][0]);
      const h = toNum(inboundHandledVals[i][0]);
      numerator += ht * h;
      denom += h;
    }
    avgHandleTime = denom > 0 ? numerator / denom : 0;
  }

  dash.getRange("A5").setValue(inboundTotal);
  dash.getRange("B5").setValue(inboundHandledTotal);
  dash.getRange("C5").setValue(abandonsTotal);
  dash.getRange("D5").setValue(cbReqTotal);
  dash.getRange("E5").setValue(avgHandleTime);
  dash.getRange("E5").setNumberFormatLocal("[h]:mm:ss");

  // KPI tile style
  const kpiTile = dash.getRange("A4:E5");
  kpiTile.getFormat().getFill().setColor("#F3F4F6");
  kpiTile.getFormat().setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
  kpiTile.getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.center);
  kpiTile.getFormat().setRowHeight(26);
  kpiTile.getFormat().getBorders().getItem(ExcelScript.BorderIndex.edgeBottom).setStyle(ExcelScript.BorderLineStyle.thin);
  kpiTile.getFormat().getBorders().getItem(ExcelScript.BorderIndex.edgeTop).setStyle(ExcelScript.BorderLineStyle.thin);
  kpiTile.getFormat().getBorders().getItem(ExcelScript.BorderIndex.edgeLeft).setStyle(ExcelScript.BorderLineStyle.thin);
  kpiTile.getFormat().getBorders().getItem(ExcelScript.BorderIndex.edgeRight).setStyle(ExcelScript.BorderLineStyle.thin);

  // ---------- Media Type Summary (write into a fixed block) ----------
  dash.getRange("A7").setValue("By Media Type");
  dash.getRange("A7").getFormat().getFont().setBold(true);

  dash.getRange("A8:C8").setValues([["Media Type Name", "Inbound", "Inbound Handled"]]);
  dash.getRange("A8:C8").getFormat().getFont().setBold(true);

  type MediaAgg = { inbound: number; handled: number };
  const mediaMap = new Map<string, MediaAgg>();

  if (mediaVals) {
    for (let i = 0; i < mediaVals.length; i++) {
      if (i === gtIdx) continue;
      const media = toStr(mediaVals[i][0]).trim();
      if (!media) continue;

      const inbound = inboundVals ? toNum(inboundVals[i][0]) : 0;
      const handled = inboundHandledVals ? toNum(inboundHandledVals[i][0]) : 0;

      const cur = mediaMap.get(media) ?? { inbound: 0, handled: 0 };
      cur.inbound += inbound;
      cur.handled += handled;
      mediaMap.set(media, cur);
    }
  }

  const rows: (string | number)[][] = Array.from(mediaMap.entries())
    .map(([k, v]) => [k, v.inbound, v.handled])
    .sort((a, b) => Number(b[1]) - Number(a[1]));

  // Clear a fixed area first so old values don't linger
  dash.getRange("A9:C40").clear(ExcelScript.ClearApplyTo.contents);

  const maxRows = Math.min(rows.length, 32); // keep dashboard tidy
  if (maxRows === 0) {
    dash.getRange("A9").setValue("No Media Type rows found.");
  } else {
    dash.getRangeByIndexes(8, 0, maxRows, 3).setValues(rows.slice(0, maxRows));
    dash.getRangeByIndexes(8, 1, maxRows, 2).setNumberFormatLocal("0");
  }

  // ---------- Charts (anchored to visible area) ----------
  // chart ranges must include header row + at least one data row
  const dataRowCount = Math.max(maxRows, 1);
  const chartDataRange = dash.getRangeByIndexes(7, 0, dataRowCount + 1, 3); // A8:C...
  const pieRange = dash.getRangeByIndexes(7, 0, dataRowCount + 1, 2);       // A8:B...

  // Remove existing charts if script is re-run (best effort)
  try {
    for (const ch of dash.getCharts()) ch.delete();
  } catch { /* ignore */ }

  const colChart = dash.addChart(ExcelScript.ChartType.columnClustered, chartDataRange);
  colChart.setPosition(dash.getRange("E8"), dash.getRange("M22"));
  try {
    const t = colChart.getTitle();
    t.setVisible(true);
    t.setText("Inbound vs Inbound Handled by Media Type");
  } catch { /* ignore */ }
  colChart.getLegend().setPosition(ExcelScript.ChartLegendPosition.bottom);

  const pieChart = dash.addChart(ExcelScript.ChartType.pie, pieRange);
  pieChart.setPosition(dash.getRange("E24"), dash.getRange("M40"));
  try {
    const t = pieChart.getTitle();
    t.setVisible(true);
    t.setText("Inbound Share by Media Type");
  } catch { /* ignore */ }
  pieChart.getLegend().setPosition(ExcelScript.ChartLegendPosition.right);

  // Final polish
  dash.getUsedRange()?.getFormat().autofitRows();
}
