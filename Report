/**Calls
 * Call History - Visual Flair + Dashboard (No Formulas Version)
 * - Styles report as a table
 * - Applies formatting + conditional formatting
 * - Builds a KPI + charts dashboard using values computed in TypeScript (no Excel formulas)
 */
function main(workbook: ExcelScript.Workbook) {
  const srcSheet = workbook.getActiveWorksheet();
  const used = srcSheet.getUsedRange();

  if (!used) throw new Error("No used range found on the active sheet.");
  if (used.getRowCount() < 2) throw new Error("Not enough rows (need header + at least 1 data row).");

  // ---------- Create / refresh table ----------
  const tableName = "CallHistory";

  // Delete existing table by name if it exists
  for (const t of workbook.getTables()) {
    if (t.getName() === tableName) {
      t.delete();
      break;
    }
  }

  const table = workbook.addTable(used, true);
  table.setName(tableName);
  table.setPredefinedTableStyle("TableStyleMedium9");

  // Freeze header row (fix for freeze panes API)
  const fp = srcSheet.getFreezePanes();
  fp.unfreeze();
  fp.freezeRows(1);

  // Autofit
  used.getFormat().autofitColumns();
  used.getFormat().autofitRows();

  // Header polish
  const headerRange = table.getHeaderRowRange();
  headerRange.getFormat().getFont().setBold(true);
  headerRange.getFormat().setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
  headerRange.getFormat().setWrapText(true);

  // ---------- Helpers ----------
  function hasColumn(colName: string): boolean {
    try {
      table.getColumnByName(colName);
      return true;
    } catch {
      return false;
    }
  }

  function getColValues(colName: string): any[][] | null {
    try {
      return table.getColumnByName(colName).getRangeBetweenHeaderAndTotal().getValues();
    } catch {
      return null;
    }
  }

  function toNum(x: any): number {
    if (x === null || x === undefined || x === "") return 0;
    if (typeof x === "number") return x;
    const n = Number(x);
    return isNaN(n) ? 0 : n;
  }

  function findRowIndexByExactText(colValues: any[][] | null, needle: string): number {
    if (!colValues) return -1;
    const target = needle.trim().toLowerCase();
    for (let i = 0; i < colValues.length; i++) {
      const v = String(colValues[i][0] ?? "").trim().toLowerCase();
      if (v === target) return i;
    }
    return -1;
  }

  // ---------- Apply column formats ----------
  const timeCols = [
    "Avg Handle Time",
    "Avg InQueue Time",
    "Avg Abandon Time",
    "Avg Callback Time",
    "Avg Hold Time",
    "Long Abandon Time",
    "Avg Short Abandon Time",
    "Held Party Abandon Time"
  ];

  for (const c of timeCols) {
    if (!hasColumn(c)) continue;
    table.getColumnByName(c).getRangeBetweenHeaderAndTotal().setNumberFormatLocal("[h]:mm:ss");
  }

  const pctCols = ["% PreQueue Time", "% Short Abandons", "% PostQueue Time"];
  for (const c of pctCols) {
    if (!hasColumn(c)) continue;
    table.getColumnByName(c).getRangeBetweenHeaderAndTotal().setNumberFormatLocal("0.00%");
  }

  const intCols = [
    "Inbound",
    "Inbound Handled",
    "Outbound Handled",
    "Abandons",
    "Callback Requests",
    "Entered Prequeue",
    "Held",
    "Long Abandons",
    "Incoming",
    "Outgoing",
    "Handled",
    "Short Abandons",
    "Agent Contacts"
  ];
  for (const c of intCols) {
    if (!hasColumn(c)) continue;
    table.getColumnByName(c).getRangeBetweenHeaderAndTotal().setNumberFormatLocal("0");
  }

  // ---------- Conditional formatting ----------
  // Abandons: highlight >0
  if (hasColumn("Abandons")) {
    const r = table.getColumnByName("Abandons").getRangeBetweenHeaderAndTotal();
    const cf = r.addConditionalFormat(ExcelScript.ConditionalFormatType.cellValue);
    cf.getCellValue().setRule({
      formula1: "0",
      operator: ExcelScript.ConditionalCellValueOperator.greaterThan
    });
    const fmt = cf.getCellValue().getFormat();
    fmt.getFill().setColor("#FDE2E2");
    fmt.getFont().setColor("#9B1C1C");
    fmt.getFont().setBold(true);
  }

  // Percent columns: data bars
  for (const c of pctCols) {
    if (!hasColumn(c)) continue;
    const r = table.getColumnByName(c).getRangeBetweenHeaderAndTotal();
    const cf = r.addConditionalFormat(ExcelScript.ConditionalFormatType.dataBar);
    const db = cf.getDataBar();
    db.setShowDataBarOnly(false);
    db.getPositiveFormat().setGradientFill(true);
  }

  // ---------- Build Dashboard ----------
  const dashName = "Dashboard";
  let dash = workbook.getWorksheet(dashName);
  if (dash) dash.delete();
  dash = workbook.addWorksheet(dashName);

  // Title
  dash.getRange("A1").setValue("LBO Call History Dashboard");
  dash.getRange("A1").getFormat().getFont().setBold(true);
  dash.getRange("A1").getFormat().getFont().setSize(18);

  // KPI Labels
  dash.getRange("A3:E3").setValues([[
    "Inbound (Total)",
    "Handled (Inbound)",
    "Abandons",
    "Callback Requests",
    "Avg Handle Time"
  ]]);
  dash.getRange("A3:E3").getFormat().getFont().setBold(true);

  // Read needed columns (safe)
  const dayCol = getColValues("Day of Week"); // used to detect Grand Total row
  const inboundVals = getColValues("Inbound");
  const inboundHandledVals = getColValues("Inbound Handled");
  const abandonsVals = getColValues("Abandons");
  const cbReqVals = getColValues("Callback Requests");
  const ahtVals = getColValues("Avg Handle Time"); // Excel time as fraction of day
  const mediaVals = getColValues("Media Type Name");

  const gtIdx = findRowIndexByExactText(dayCol, "Grand Total");

  function sumColumn(vals: any[][] | null, excludeIdx: number): number {
    if (!vals) return 0;
    let s = 0;
    for (let i = 0; i < vals.length; i++) {
      if (i === excludeIdx) continue;
      s += toNum(vals[i][0]);
    }
    return s;
  }

  function valueOrSum(vals: any[][] | null, preferredIndex: number): number {
    if (!vals) return 0;
    if (preferredIndex >= 0 && preferredIndex < vals.length) return toNum(vals[preferredIndex][0]);
    return sumColumn(vals, -1);
  }

  const inboundTotal = valueOrSum(inboundVals, gtIdx);
  const inboundHandledTotal = valueOrSum(inboundHandledVals, gtIdx);
  const abandonsTotal = valueOrSum(abandonsVals, gtIdx);
  const cbReqTotal = valueOrSum(cbReqVals, gtIdx);

  // Weighted Avg Handle Time (exclude Grand Total to avoid double counting)
  let avgHandleTime = 0;
  if (ahtVals && inboundHandledVals) {
    let numerator = 0;
    let denom = 0;
    for (let i = 0; i < ahtVals.length; i++) {
      if (i === gtIdx) continue;
      const ht = toNum(ahtVals[i][0]);         // fraction of day
      const h = toNum(inboundHandledVals[i][0]);
      numerator += ht * h;
      denom += h;
    }
    avgHandleTime = denom > 0 ? numerator / denom : 0;
  }

  // Write KPI values
  dash.getRange("A4").setValue(inboundTotal);
  dash.getRange("B4").setValue(inboundHandledTotal);
  dash.getRange("C4").setValue(abandonsTotal);
  dash.getRange("D4").setValue(cbReqTotal);
  dash.getRange("E4").setValue(avgHandleTime);
  dash.getRange("E4").setNumberFormatLocal("[h]:mm:ss");

  // KPI tile style
  const kpiTile = dash.getRange("A3:E4");
  kpiTile.getFormat().getFill().setColor("#F3F4F6");
  kpiTile.getFormat().setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
  kpiTile.getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.center);
  kpiTile.getFormat().setRowHeight(24);

  // Media Type Summary Table
  dash.getRange("A6").setValue("By Media Type (excluding Grand Total)");
  dash.getRange("A6").getFormat().getFont().setBold(true);

  dash.getRange("A7:C7").setValues([["Media Type Name", "Inbound", "Inbound Handled"]]);
  dash.getRange("A7:C7").getFormat().getFont().setBold(true);

  const mediaMap = new Map<string, { inbound: number; handled: number }>();

  if (mediaVals) {
    for (let i = 0; i < mediaVals.length; i++) {
      if (i === gtIdx) continue;

      const media = String(mediaVals[i][0] ?? "").trim();
      if (!media) continue;

      const inbound = inboundVals ? toNum(inboundVals[i][0]) : 0;
      const handled = inboundHandledVals ? toNum(inboundHandledVals[i][0]) : 0;

      const cur = mediaMap.get(media) ?? { inbound: 0, handled: 0 };
      cur.inbound += inbound;
      cur.handled += handled;
      mediaMap.set(media, cur);
    }
  }

  const rows = Array.from(mediaMap.entries())
    .map(([k, v]) => [k, v.inbound, v.handled])
    .sort((a, b) => (b[1] as number) - (a[1] as number));

  if (rows.length === 0) {
    dash.getRange("A8").setValue("No Media Type rows found (check column names).");
  } else {
    // Write data starting at A8 (row index 7)
    dash.getRangeByIndexes(7, 0, rows.length, 3).setValues(rows);
    dash.getRangeByIndexes(7, 1, rows.length, 2).setNumberFormatLocal("0");
  }

  // ---------- Charts ----------
  // Define chart ranges based on actual number of rows written
  const dataRowCount = Math.max(rows.length, 1); // at least 1 row for chart range stability

  // A7:C(7+dataRowCount) -> includes header row + data rows
  const chartDataRange = dash.getRangeByIndexes(6, 0, dataRowCount + 1, 3);
  const pieRange = dash.getRangeByIndexes(6, 0, dataRowCount + 1, 2);

  // Column chart: Inbound vs Handled
  const colChart = dash.addChart(ExcelScript.ChartType.columnClustered, chartDataRange);
  colChart.setPosition(dash.getRange("E7"), dash.getRange("L20"));

  // Set chart title safely
  const ct = colChart.getTitle();
  ct.setVisible(true);
  ct.setText("Inbound vs Inbound Handled by Media Type");

  colChart.getLegend().setPosition(ExcelScript.ChartLegendPosition.bottom);

  // Pie chart: Inbound Share
  const pieChart = dash.addChart(ExcelScript.ChartType.pie, pieRange);
  pieChart.setPosition(dash.getRange("A22"), dash.getRange("D35"));

  const pt = pieChart.getTitle();
  pt.setVisible(true);
  pt.setText("Inbound Share by Media Type");

  pieChart.getLegend().setPosition(ExcelScript.ChartLegendPosition.right);

  // Final polish
  dash.getUsedRange()?.getFormat().autofitColumns();
  dash.getUsedRange()?.getFormat().autofitRows();
}
